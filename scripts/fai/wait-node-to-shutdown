#!/bin/bash
set -e -o pipefail
args=("$@")
MAC_ADDRESS=${args[0]}
if [ -z "$MAC_ADDRESS" ]; then
    echo "MAC_ADDRESS is empty"
    exit 1
fi
IDENTITY_FILE=${args[1]}
if [ -z "$IDENTITY_FILE" ]; then
    echo "IDENTITY_FILE is empty"
    exit 1
fi
while true; do
    wakeonlan $MAC_ADDRESS > /dev/null 2>&1 || true
    echo
    echo "Wake on lan sent. Make sure your client machine is turned off before running this script or you can boot it from Network Boot manually."
    sleep 3
    DNSMASQ_LOG=$(docker exec fai bash -c "tail -n100 /tmp/dnsmasq.log")
    echo "DNSMASQ_LOG: $DNSMASQ_LOG"
    MAC_ADDRESS_LOWER=$(echo $MAC_ADDRESS | tr '[:upper:]' '[:lower:]')
    MATCH_LINE=$(echo "$DNSMASQ_LOG" | grep "PXE(" | grep "$MAC_ADDRESS_LOWER pxelinux.0") || true
    if [ -z "$MATCH_LINE" ]; then
        continue
    fi
    echo "MATCH_LINE: $MATCH_LINE"
    IP_ADDRESS=$(echo $MATCH_LINE | awk '{print $7}')
    echo "IP_ADDRESS: $IP_ADDRESS"
    # validate IP_ADDRESS
    if [[ $IP_ADDRESS == 192.168.* ]]; then
        break
    fi
done
echo "IP_ADDRESS: $IP_ADDRESS"

SQUASH_IMG_FILESIZE_HUMAN=$(docker exec fai bash -c "du -h /var/www/html/squash.img" | awk '{print $1}')
PXE_SERVER_IP_ADDRESS=$(hostname -I | awk '{print $1}')
echo "PXE_SERVER_IP_ADDRESS: $PXE_SERVER_IP_ADDRESS"
CURL_HEAD_SQUASH_IMG=$(curl -s -I "http://$PXE_SERVER_IP_ADDRESS/squash.img" -X HEAD -w '%{http_code}' -o /dev/null)
echo "CURL_HEAD_SQUASH_IMG: $CURL_HEAD_SQUASH_IMG"
if [ "$CURL_HEAD_SQUASH_IMG" == "200" ]; then
    echo "Squash.img is ready"
else
    echo "Squash.img is not ready. Waiting for it to be ready"
    exit 1
fi
while true; do
    echo "Downloading squash.img ($SQUASH_IMG_FILESIZE_HUMAN, this may take a while)"
    sleep 16
    nc -z -w 1 "$IP_ADDRESS" 22 > /dev/null 2>&1 && break || continue;
done
echo "SSH is ready"
while true; do
    echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") SSH is ready."
    sleep 12
    ssh-keygen -R "$IP_ADDRESS" > /dev/null 2>&1 || true
    ssh-keyscan "$IP_ADDRESS" >> ~/.ssh/known_hosts > /dev/null 2>&1 || true
    (timeout 10 ssh \
        -o PasswordAuthentication=no \
        -o StrictHostKeyChecking=no \
        -i $IDENTITY_FILE root@$IP_ADDRESS "echo 'The node is ready'" > /dev/null 2>&1) && break || continue;
done

./pic list-mass-storage $IP_ADDRESS $IDENTITY_FILE && \
    echo "Mass Storage USB is found. Installation is failed. Please remove the USB Flash Drive and try again." && exit 1 || true
echo "Mass Storage USB is not found. Continue"
docker restart fai
while true; do
    echo "Waiting for finish installation"
    ping -c1 "$IP_ADDRESS" > /dev/null 2>&1 || break;
    sleep 6
done
echo "  Node is installed successfully. Rebooting the node"
ssh-keygen -R "$IP_ADDRESS" > /dev/null 2>&1 || true
ssh-keyscan "$IP_ADDRESS" >> ~/.ssh/known_hosts > /dev/null 2>&1 || true
while true; do
    wakeonlan $MAC_ADDRESS > /dev/null 2>&1 || true
    # echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") SSH is ready. Waiting for private key to be ready"
    sleep 2
    (timeout 2 ssh \
        -o PasswordAuthentication=no \
        -o StrictHostKeyChecking=no \
        -i $IDENTITY_FILE root@$IP_ADDRESS "echo" > /dev/null 2>&1) && break || continue;
done
echo
ssh -i $IDENTITY_FILE root@$IP_ADDRESS "cat /etc/os-release"
echo "Now you can SSH to the node with this command:"
echo "  ssh -i $IDENTITY_FILE $IP_ADDRESS"

