set -e -o pipefail
source .env
GITLAB_TOKEN=$(./pic get-refresh-token-gitlab)
FQDN_ADDRESS="http-gitlab-webservice-default-gitlab-ns-8181.$DOMAIN"
args=("$@")
PROJECT_NAME=${args[0]}
ref=${args[1]}
option2=${args[2]}
URL="https://$FQDN_ADDRESS/api/v4/projects/$PROJECT_NAME/pipeline"
PAYLOAD=$(jq --arg ref $ref '.ref = $ref' <<<'{}')
echo "PAYLOAD: $PAYLOAD"
while true; do
    PIPELINE=`curl -s --request POST \
        --data "$PAYLOAD" \
        --header "Content-Type: application/json" \
        --header "Authorization: Bearer $GITLAB_TOKEN" \
        $URL` || continue;
    echo "PIPELINE: $PIPELINE"
    InternalServerErrorMessage="500 Internal Server Error"
    PIPELINE_MESSAGE=$(echo $PIPELINE | jq -r ".message")
    if [ "$InternalServerErrorMessage" == "$PIPELINE_MESSAGE" ]; then
        echo "Internal Server Error"
        sleep 2
        continue
    fi
    break;
    echo "Retrying to create pipeline"
    sleep 12
done
if [ "wait-for-success" == "$option2" ]; then
    while true; do
        ./pic succeed-pipeline $PROJECT_NAME $ref && break || true
        echo "Waiting for pipeline to succeed"
        sleep 15
    done
fi
