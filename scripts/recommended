source .env
if [ -z $DOMAIN ]; then
    echo "DOMAIN is empty. Please specify in .env file"
    exit 1
fi
if [ -z $EMAIL ]; then
    echo "EMAIL is empty. Please specify in .env file"
    exit 1
fi
cat ~/.ssh/id_rsa.pub || ssh-keygen
set -e -o pipefail
args=("$@")
IDENTIFY_FILE=${args[0]}
echo "IDENTIFY_FILE: $IDENTIFY_FILE"
if [ -z "$IDENTIFY_FILE" ]; then
    echo "IDENTIFY_FILE is empty. Specify a node ip for the new machine."
    echo "Usage: ./pic recommended IDENTIFY_FILE"
    exit 1
fi
if [ ! -f $IDENTIFY_FILE ]; then
    echo "$IDENTIFY_FILE does not exist. Please create a ssh key pair in order to connect to the new machine."
    echo "If you've already booted machines use ./pic FAI (Fully Automatic Installation), please upload ./id_rsa in your github account into the current directory"
    echo "Usage: ./pic recommended IDENTIFY_FILE"
    exit 1
fi
stat gitlab.json || \
jq -n \
    --arg GITLAB_ROOT_GENERATED_PASSWORD "$(openssl rand -hex 16)" \
    '{"gitlab_root_generated_password":$GITLAB_ROOT_GENERATED_PASSWORD}' > gitlab.json
GITLAB_ROOT_GENERATED_PASSWORD=$(jq -r '.gitlab_root_generated_password' gitlab.json)
echo "Installing recommended packages"
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
PIC_DIR="$HOME/.pic"
LOGS_DIR="$PIC_DIR/logs/"
SCRIPTS_DIR="$PIC_DIR/scripts"
mkdir -p $LOGS_DIR
mkdir -p $SCRIPTS_DIR
echo "{}" > "$HOME/.pic/expose-items.json"
# 
echo;time ./pic reinstall-k3s $IDENTIFY_FILE | tee $LOGS_DIR/reinstall-k3s.log
rm -rf $LOGS_DIR/reinstall-k3s.log
# 
echo;time ./pic redis | tee $LOGS_DIR/redis.log
rm -rf $LOGS_DIR/redis.log
# 
echo;time ./pic csi-s3 | tee $LOGS_DIR/csi-s3.log
rm -rf $LOGS_DIR/csi-s3.log
# 
echo;time ./pic gitlab $IDENTIFY_FILE | tee $LOGS_DIR/gitlab.log
rm -rf $LOGS_DIR/gitlab.log
# 
echo;time ./pic grafana-promtail-loki "lokiadmin" "$GITLAB_ROOT_GENERATED_PASSWORD" | tee $LOGS_DIR/grafana-promtail-loki.log
rm -rf $LOGS_DIR/grafana-promtail-loki.log
# 
echo "./pic has installed your recommended packages"
exit 0
