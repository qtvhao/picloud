K8S_MASTER_NODE_IP=$(hostname -I | cut -d' ' -f1)
echo "K8S_MASTER_NODE_IP: $K8S_MASTER_NODE_IP"
echo "Installing k3s"
docker network inspect picloud || docker network create picloud
docker inspect picloud-k3s-server && docker rm -f picloud-k3s-server
docker run -d --restart=unless-stopped \
    --privileged \
    --name picloud-k3s-server \
    --network picloud \
    -p 6448:6443 \
    -e INSTALL_K3S_EXEC="--flannel-backend=none --no-flannel" \
    rancher/k3s:v1.27.6-k3s1 \
    server --disable-network-policy --disable servicelb --disable traefik --disable metrics-server --tls-san k3s-server-1 --tls-san $K8S_MASTER_NODE_IP --advertise-address $K8S_MASTER_NODE_IP --advertise-port 6448
K3S_URL="https://$K8S_MASTER_NODE_IP:6448"
while ! docker exec picloud-k3s-server /bin/sh -c "cat /var/lib/rancher/k3s/server/token" >/dev/null 2>&1; do
    echo "Waiting for K3S token"
    sleep 1
done
K3S_TOKEN=$(docker exec picloud-k3s-server /bin/sh -c "cat /var/lib/rancher/k3s/server/token")
NODE_COMMAND="curl -sfL https://get.k3s.io | K3S_URL=$K3S_URL K3S_TOKEN=$K3S_TOKEN sh -"
echo "Joining worker node to this cluster"
sh -c "$NODE_COMMAND"
echo
echo "To join a worker node to this cluster, run the following command:"
echo "    $NODE_COMMAND"