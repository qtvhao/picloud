#!/bin/bash
set -e -o pipefail

args=("$@")
IDENTIFY_FILE=${args[0]}
if [ -z "$IDENTIFY_FILE" ]; then
    echo "IDENTIFY_FILE is empty. Specify a node ip for the new machine."
    echo "Usage: ./pic auto-join IDENTIFY_FILE"
    exit 1
fi
K8S_MASTER_NODE_IP=$(hostname -I | cut -d' ' -f1)
if [ ! -f "NODES" ]; then
    echo "NODES file does not exist. Creating NODES file"
    echo "" > NODES
    nodesOnLan=$(./pic list-nodename $IDENTIFY_FILE | awk '{print $1}' | tr '\n' ' ')
    for node in $nodesOnLan; do
        if [ "$K8S_MASTER_NODE_IP" == "$node" ]; then
            continue
        fi
        if [ -z "$node" ]; then
            continue
        fi
        echo "$node" >> NODES
        ssh-keygen -R "$node" || true
        ssh-keyscan "$node" >> /root/.ssh/known_hosts
        THE_HOSTNAME=$(ssh -i $IDENTIFY_FILE $node hostname)
        echo "$THE_HOSTNAME"
    done
fi
while read node; do
    if [ -z "$node" ]; then
        continue
    fi
    ( time (./pic join-k3s "$node" $IDENTIFY_FILE) | tee $LOGS_DIR/join-k3s.log) &
done < NODES
wait
