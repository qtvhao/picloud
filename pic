#! /bin/bash
isRoot=$(whoami)
if [ "$isRoot" != "root" ]; then
    echo "Please run as root"
    exit 1
fi
args=("$@")
arg1=${args[0]}
if [ "$arg1" == "update" ]; then
    echo "Updating PiCloud"
    curl "https://raw.githubusercontent.com/qtvhao/picloud/main/pic?$(date +%s)" -o pic && chmod +x pic
    exit 0
fi
if [ "$arg1" == "install" ]; then
    echo "Installing Docker"
    curl -fsSL https://get.docker.com -o install-docker.sh
    chmod +x install-docker.sh
    docker version || ./install-docker.sh
    echo "Installed Docker"
    rm install-docker.sh
    ./pic expose
    ./pic reinstall-k3s
    exit 0
fi
if [ "$arg1" == "expose" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/cloudflared" \
    "expose" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "remove" ]; then
    echo "Removing PiCloud"
    docker rm -f picloud-k3s-server
    apt remove docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-ce-rootless-extras docker-buildx-plugin -y >/dev/null
    exit 0
fi
if [ "$arg1" == "start" ]; then
    echo "Starting PiCloud"
    exit 0
fi
if [ "$arg1" == "stop" ]; then
    echo "Stopping PiCloud"
    exit 0
fi
if [ "$arg1" == "restart" ]; then
    echo "Restarting PiCloud"
    exit 0
fi
if [ "$arg1" == "status" ]; then
    echo "Status of PiCloud"
    echo "PiCloud is running"
    exit 0
fi
if [ "$arg1" == "reinstall-k3s" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/k3s" \
    "reinstall-k3s" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "wait" ]; then
    set -e
    RESOURCE_TYPE=$2
    DEPLOYMENT=$3
    NAMESPACE=$4
    CONDITION=$5
    while true; do
        kubectl wait --for=condition=$CONDITION $RESOURCE_TYPE/$DEPLOYMENT -n $NAMESPACE --timeout 10s && break || sleep 5
    done
    exit 0
fi
if [ "$arg1" == "s3" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/storage" \
    "install-minio" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "redis" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/database" \
    "install-redis" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "exec-local-or-remote" ]; then
    set -e
    scriptFile="./$3"
    remoteUrl="https://raw.githubusercontent.com/qtvhao/picloud/main/$2/$3"
    echo "scriptFile: $scriptFile"
    echo "scriptFile exists: $(test -f "$scriptFile" && echo "true" || echo "false")"
    echo "remoteUrl: $remoteUrl"
    echo "arg \$4: $4"
    echo "arg \$5: $5"
    echo "arg \$6: $6"
    echo "arg \$7: $7"
    echo "arg \$8: $8"
    scriptFileExists=$(test -f "$2/$3" && echo "true" || echo "false")
    if [ "$scriptFileExists" == "true" ]; then
        cp "$2/$3" "$scriptFile"
    else
        curl $remoteUrl -o $scriptFile
    fi
    chmod +x $scriptFile
    "$scriptFile" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    rm $scriptFile
    exit 0
fi
if [ "$arg1" == "csi-s3" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/storage" \
    "install-minio-csi-driver" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "pxe-boot" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/infrastructure" \
    "pxe-boot" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    # for example ./pic pxe-boot 192.168.1.110 8c:dc:d4:34:0c:f0 sda eno1
    exit 0
fi
if [ "$arg1" == "cilium" ]; then
    echo "Installing Cilium"
    helm repo add cilium https://helm.cilium.io/
    helm install cilium cilium/cilium --namespace=kube-system
    exit 0
fi
if [ "$arg1" == "registry-as-a-pull-through-cache" ]; then
    echo "Installing registry-as-a-pull-through-cache"
fi
if [ "$arg1" == "gitlab" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/continuous-integration-deployment" \
    "install-gitlab" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "grafana-promtail-loki" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/logging-monitoring" \
    "grafana-promtail-loki" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "join-k3s" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/k3s" \
    "join-k3s" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "git-folk" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/continuous-integration-deployment" \
    "git-folk" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "init-terraform" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/infrastructure" \
    "init-terraform" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "fai" ]; then
    set -e
    ./pic exec-local-or-remote "scripts/fai" \
    "install" "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9" "${10}"
    exit 0
fi
if [ "$arg1" == "dd" ]; then
    set -e
    syslinux -h || apt-get install syslinux -y
    pv -h || apt-get install pv -y
    args=("$@")
    HOSTNAME=${args[1]}
    USB_DEVICE=${args[2]}
    if [ "$HOSTNAME" == "" ]; then
        echo "Please provide hostname"
        exit 1
    fi
    if [ "$USB_DEVICE" == "" ]; then
        echo
        lsblk -n --nodeps
        echo "Please provide USB device"
        exit 1
    fi
    echo "HOSTNAME: $HOSTNAME"
    echo "USB_DEVICE: $USB_DEVICE"
    FILE_SIZE_IN_MB=$(du -m $HOSTNAME-fai-cd.iso | cut -f1)
    echo "File size in MB: $FILE_SIZE_IN_MB""Mb"
    echo "Deleting All Partitions From $USB_DEVICE"

    echo "Creating Partition scheme MBR"
    echo "Target system: BIOS"
    echo "Persistent partition size: 0"
    echo "File system type: fat32"
    echo "Cluster size: 8192 bytes (default)"
    # Quick format
    # Create extended label and icon files
    dd if=/dev/zero of=$USB_DEVICE bs=1M count=1
    parted -s $USB_DEVICE mklabel msdos
    parted -s $USB_DEVICE mkpart primary fat32 0% 100%
    parted -s $USB_DEVICE set 1 boot on
    # set MBR

    # Create file system FAT32 with label "FAI" and icon "FAI" on $USB_DEVICE partition 1
    mkfs.vfat -F 32 -n "FAI" -I $USB_DEVICE
    # isohybrid $HOSTNAME-fai-cd.iso --entry 4 --type 0x1c
    # Create file system ext4 with label "FAI" on $USB_DEVICE partition 2
    # copy $HOSTNAME-fai-cd.iso to $USB_DEVICE partition 1
    dd if=$HOSTNAME-fai-cd.iso of=$USB_DEVICE bs=1M status=progress
    exit 0
    # status=progress
fi
if [ "$arg1" == "find-nodename" ]; then
    args=("$@")
    NODE_NAME=${args[1]}
    echo "NODE_NAME: $NODE_NAME"
    MAX=255
    for i in `seq 1 $MAX`; do
        echo "Checking 192.168.1.$i"
        timeout .1 ssh -o PasswordAuthentication=no -o PubkeyAuthentication=yes -i ~/.ssh/id_rsa \
         "192.168.1.$i" "cat /var/log/fai/ip-192-168-1-13/last-install/boot.log | grep -i IPADDR" || true
    done
    exit 0
fi
if [ "$arg1" == "help" ]; then
    ./pic exec-local-or-remote "scripts" \
    "help"
    exit 0
fi
if [ "$arg1" == "local-registry" ]; then
    set -e
    docker rm -f docker-registry || true
    docker run -d --name docker-registry -p 5000:5000 \
        -v ./k8s/.docker-registry-data:/var/lib/registry \
        -e REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io \
        --restart always \
        registry:2
    REGISTRY_IP_ADDRESS=$(hostname -I | head -n1 | awk '{print $1}')
    cat <<EOF > /etc/docker/daemon.json
{
    "insecure-registries":["$REGISTRY_IP_ADDRESS:5000"],
    "registry-mirrors": ["http://$REGISTRY_IP_ADDRESS:5000"],
    "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
    }
}
EOF
    service docker restart
    docker pull alpine
exit 0
fi
./pic help
